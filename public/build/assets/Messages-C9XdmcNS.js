import{aS as o,aC as ce,as as U,bC as pe,aH as fe,u as n,aK as i,I as Z,v as e,F as ee,aV as se,at as y,bi as a,t as te,b9 as d,bM as K,bJ as he,by as ve,bK as le,ak as ge}from"./vendor-Cy4BBKy_.js";import{a as me,h as _e,u as xe,s as ye,i as we}from"./app-i4sZYluG.js";import{_ as be}from"./AuthPageHeader-B7hSdchQ.js";import{d as ae,a as E}from"./utilities-STV8t6c4.js";import{u as ke}from"./framework-C9q9PHhQ.js";import{x as Me}from"./ui-BDBDEXQQ.js";import"./icons-DjuF0c5-.js";const Se="/build/assets/search-D8JnBFNm.svg",Te={class:"h-full lg:h-[80vh] flex flex-col"},Ce={class:"flex-1 overflow-hidden p-3"},je={class:"flex flex-col lg:flex-row h-full overflow-hidden p-3 bg-white gap-2 lg:gap-4 rounded-2xl"},Le={class:"w-full lg:w-2/5 xl:w-2/5 h-[40vh] lg:h-full border-r bg-gray-100 p-2 lg:p-3 rounded-2xl overflow-auto"},Ee={class:"p-2 lg:p-4 border-b relative"},Fe={class:"divide-y divide-gray-50 p-1 xl:p-2"},He=["onClick"],Ae={class:"flex items-center flex-wrap gap-1 space-x-1"},Be=["src"],De=["id"],Pe=["id"],Ye={class:"text-xs text-gray-500 whitespace-nowrap"},ze={key:0,class:"p-3 bg-gray-100 rounded-2xl w-full lg:w-3/5 xl:w-3/5"},Ue={class:"h-[70vh] lg:h-full bg-white rounded-2xl shadow-lg flex flex-col overflow-y-auto z-50"},Ke={class:"bg-gray-900 text-white px-4 py-3 flex items-center justify-between cursor-pointer"},$e={class:"flex items-center gap-2"},Ne=["src"],Ve={class:"font-semibold"},Oe={key:0,class:"flex justify-center items-center"},Ie={key:0,class:"space-y-1"},Re={class:"flex items-center gap-3 p-4 border rounded-lg"},Je=["src"],qe={class:"flex flex-col text-sm"},Ge={class:"font-semibold leading-tight text-wrap"},Qe={class:"flex justify-between items-center gap-2 mt-1"},We={class:"font-semibold"},Xe={class:"flex items-center gap-1 text-xs"},Ze={class:"font-semibold"},es={class:"text-gray-500"},ss={class:"text-xs text-gray-500 mt-1"},ts=["innerHTML"],ls={class:"text-xs text-gray-500 mt-1"},as=["src"],os=["src"],rs={class:"p-3 flex items-center gap-2"},ns={class:"flex items-center gap-2 w-full border rounded-lg py-3 px-3"},is=["onKeydown"],us={key:1,class:"text-center text-gray-500 py-4 border w-full h-full flex flex-col items-center justify-center"},ds=20,cs=20,ys={__name:"Messages",setup(ps){const oe=ke(),p=o(null),b=o(null),k=o(!1),f=me(),u=_e(),g=xe();let F=o(!1),$,m=null,H=o([]),h=o(""),N=o(""),_=o([]),P=o(1),M=o(!1),A=o(!1),B=o(1),S=o(!1),w=o(!1),Y=!0,T=o({message:null,created_at:null,type:"user",user:{profile_photo:null}});const C=()=>{U(()=>{p.value&&(p.value.scrollTop=p.value.scrollHeight)})},re=async l=>{l.unread_message_shop=0,u.activeShop=null,u.activeShop=l.shop,P.value=1,A.value=!1,D()},V=async()=>{var s,r;const l=await E.get("/unread-messages",{params:{user_id:(s=f.user)==null?void 0:s.id}});u.unreadMessages=(r=l.data.data)==null?void 0:r.unread_messages},j=async()=>{if(!(w.value||S.value)){w.value=!0;try{const l=await E.get("get-shops",{params:{search:N.value,page:B.value,per_page:cs},headers:{Authorization:f.token}});if(l.data.data){const s=l.data.data.data;s.length===0?S.value=!0:B.value>1?H.value=[...H.value,...s]:H.value=s,w.value=!1}}catch(l){console.log("Error fetching shops:",l),w.value=!1,S.value=!0}finally{w.value=!1}}},D=async(l=!1)=>{var s,r;if(!(M.value||A.value)){M.value=!0;try{const t=(r=(await E.get("/get-message",{params:{shop_id:(s=u.activeShop)==null?void 0:s.id,page:P.value,per_page:ds},headers:{Authorization:f.token}})).data.data)==null?void 0:r.data;if(t.length===0)A.value=!0;else if(l){const c=p.value.scrollHeight;_.value=[...t.reverse(),..._.value],await U();const x=p.value.scrollHeight;p.value.scrollTop+=x-c}else _.value=t.reverse(),C();F.value=_.value.some(c=>(c==null?void 0:c.shop_active_status)===!0),V()}finally{M.value=!1}}},O=async()=>{var s,r;if(!h.value)return;const l=h.value;h.value="",T.value.message=l,T.value.created_at=new Date,T.value.user.profile_photo=f.user.profile_photo,_.value=[..._.value,T.value],T.value={message:null,created_at:null,type:"user",user:{profile_photo:null}},C(),k.value=!1;try{k.value=!0,document.getElementById(`user-last-message${(s=u.activeShop)==null?void 0:s.id}`).innerText=h.value;const v=await E.post("/send-message",{shop_id:(r=u.activeShop)==null?void 0:r.id,message:l,type:"user"},{headers:{Authorization:f.token}});k.value=!1,j(),ie(),C()}catch{h.value="",k.value=!1,C()}k.value=!1};ce(async()=>{var l,s;await U(),C(),j(),D(),J(),(l=p.value)==null||l.addEventListener("scroll",I),(s=b.value)==null||s.addEventListener("scroll",R)}),pe(()=>{var l;return{key:g.pusher_app_key,cluster:g.pusher_app_cluster,userId:(l=f.user)==null?void 0:l.id}},()=>{J()});const I=()=>{p.value.scrollTop<300&&!M.value&&!A.value&&(P.value+=1,D())},R=()=>{if(!b.value)return;const l=b.value.scrollTop;l>400&&(Y=!0),l<300&&Y&&!w.value&&!S.value&&(Y=!1,B.value+=1,j())};fe(()=>{var l,s;(l=p.value)==null||l.removeEventListener("scroll",I),(s=b.value)==null||s.removeEventListener("scroll",R),m&&(m(),m=null)});const J=async()=>{var l;if(m&&(m(),m=null),!(!g.pusher_app_key||!((l=f.user)!=null&&l.id)))try{m=await ye({key:g.pusher_app_key,cluster:g.pusher_app_cluster},`chat_user_${f.user.id}`,"send-message-to-user",()=>{oe.path=="/massages"&&(j(),D(),V())})}catch(s){console.error("Failed to initialise chat listener",s)}},ne=l=>{clearTimeout($),$=setTimeout(()=>{N.value=l.target.value,B.value=1,S.value=!1,j()},500)},ie=async()=>{await E.post("/update-last-seen",{},{headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:f.token}})},ue=l=>{const s=document.createElement("div");return s.innerText=l,s.innerHTML},de=l=>{if(!l)return"";const s=/(\bhttps?:\/\/[^\s]+)/g;return l.replace(s,r=>{const v=ue(r);return`<a href="${v}" target="_blank" rel="noopener noreferrer" class="underline text-blue-300 hover:text-blue-100">${v}</a>`})};return(l,s)=>{var r,v;return i(),n("div",Te,[Z(be,{title:l.$t("Messages")},null,8,["title"]),e("div",Ce,[e("div",je,[e("aside",Le,[e("div",{ref_key:"shopContainer",ref:b,class:"bg-white rounded-2xl h-full max-h-[90vh] overflow-y-auto"},[e("div",Ee,[e("input",{type:"text",placeholder:"Search Seller",onKeyup:s[0]||(s[0]=t=>ne(t)),class:"w-full pl-10 py-3 md:py-4 pr-4 border rounded-lg text-sm md:text-base"},null,32),s[3]||(s[3]=e("img",{src:Se,alt:"search",class:"w-5 h-5 lg:w-6 lg:h-6 absolute top-[50%] translate-y-[-50%] left-4 lg:left-8"},null,-1))]),e("ul",Fe,[(i(!0),n(ee,null,se(a(H),t=>{var c,x,L;return i(),n("li",{onClick:z=>re(t),class:y(["flex flex-col-reverse xl:flex-row gap-2 items-start justify-between p-2 xl:p-4 transition-all duration-500 rounded-lg cursor-pointer",((c=a(u).activeShop)==null?void 0:c.id)==t.shop.id?"bg-pink-100 hover:bg-pink-100":"bg-white hover:bg-gray-100"])},[e("div",Ae,[e("img",{src:t.shop.logo,alt:"",class:y(["w-6 h-6 md:w-8 md:h-8 lg:w-10 lg:h-10 rounded-full border",((x=a(u).activeShop)==null?void 0:x.id)==t.shop.id?"border-red-500":"border-white"])},null,10,Be),e("div",null,[e("div",{class:y(["font-semibold text-xs lg:text-base flex items-center gap-1",((L=a(u).activeShop)==null?void 0:L.id)==t.shop.id?"text-red-500":"text-gray-900"])},[e("span",null,d(t.shop.name),1),t.unread_message_shop>0?(i(),n("span",{key:0,id:"shop-unread-message"+t.shop.id,class:"text-xs text-white bg-red-500 w-4 h-4 rounded-full flex items-center justify-center"},d(t.unread_message_shop),9,De)):te("",!0)],2),e("div",{class:"text-xs text-gray-600 line-clamp-2",id:"user-last-message"+t.shop.id},d(t.last_message),9,Pe)])]),e("div",Ye,d(t.last_message_time),1)],10,He)}),256))])],512)]),a(u).activeShop?(i(),n("div",ze,[e("div",Ue,[e("div",Ke,[e("div",$e,[e("img",{src:(r=a(u).activeShop)==null?void 0:r.logo,alt:"Logo",class:"w-8 h-8 rounded-full"},null,8,Ne),e("div",null,[e("p",Ve,d((v=a(u).activeShop)==null?void 0:v.name),1),e("p",{class:y(["text-sm",{"text-green-400":a(F),"text-red-400":!a(F)}])},d(a(F)?"Online":"Offline"),3)])])]),e("div",{ref_key:"chatContainer",ref:p,class:"overflow-y-auto p-4 space-y-4 text-sm flex-1"},[a(M)?(i(),n("div",Oe,s[4]||(s[4]=[e("div",{class:"animate-spin rounded-full h-6 w-6 border-t-2 border-b-2 border-pink-500"},null,-1)]))):te("",!0),(i(!0),n(ee,null,se(a(_),t=>{var c,x,L,z,q,G,Q,W,X;return i(),n("div",{class:y(["flex justify-end items-start gap-1 w-full",t.type=="user"?"":"flex-row-reverse"])},[t.product&&t.message==null?(i(),n("div",Ie,[e("div",Re,[e("img",{src:(c=t.product)==null?void 0:c.thumbnail,alt:"Product",class:"w-12 h-12 rounded-lg object-cover"},null,8,Je),e("div",qe,[e("p",Ge,d((x=t.product)==null?void 0:x.name),1),e("div",Qe,[e("p",We,d(((L=t.product)==null?void 0:L.discount_price)>0?a(g).showCurrency(parseFloat((z=t.product)==null?void 0:z.discount_price).toFixed(2)):a(g).showCurrency(parseFloat((q=t.product)==null?void 0:q.price).toFixed(2))),1),e("div",Xe,[Z(a(Me),{class:"w-4 h-4 text-amber-500"}),e("span",Ze,d((G=t.product)==null?void 0:G.rating),1),e("span",es,"("+d((Q=t.product)==null?void 0:Q.total_reviews)+")",1)])])])]),e("p",ss,d(a(ae)(t.created_at).format("hh:mm a, DD MMM, YYYY")),1)])):(i(),n("div",{key:1,class:y(["flex flex-col max-w-[75%]",t.type=="user"?"text-end justify-end items-end":"text-start justify-start items-start"])},[e("div",{class:y(["w-fit max-w-full px-4 py-2 rounded-xl break-words text-justify",t.type=="user"?"bg-[#EE446A] text-white":"bg-gray-50 text-black"]),innerHTML:de(t.message)},null,10,ts),e("p",ls,d(a(ae)(t.created_at).format("hh:mm a, DD MMM, YYYY")),1)],2)),t.type=="user"?(i(),n("img",{key:2,src:(W=t.user)==null?void 0:W.profile_photo,alt:"User",class:"w-10 h-10 rounded-full"},null,8,as)):(i(),n("img",{key:3,src:(X=t.shop)==null?void 0:X.logo,alt:"User",class:"w-10 h-10 rounded-full"},null,8,os))],2)}),256))],512),s[6]||(s[6]=e("div",{class:"border-t-2 w-2/3 mx-auto"},null,-1)),e("form",{onSubmit:K(O,["prevent"])},[e("div",rs,[e("div",ns,[he(e("textarea",{type:"text",rows:"1",placeholder:"Type a message","onUpdate:modelValue":s[1]||(s[1]=t=>ge(h)?h.value=t:h=t),onKeydown:[le(K(O,["exact","prevent"]),["enter"]),s[2]||(s[2]=le(K(()=>{},["shift"]),["enter"]))],class:"flex-1 border-0 rounded-lg text-sm focus:outline-none resize-none break-words"},null,40,is),[[ve,a(h)]]),s[5]||(s[5]=e("button",{type:"submit",class:"text-white mr-3"},[e("img",{src:we,alt:"chat",class:"w-6 h-6"})],-1))])])],32)])])):(i(),n("div",us,s[7]||(s[7]=[e("div",{class:"space-y-2"},[e("p",{class:"font-semibold"},"No User Selected"),e("p",{class:"text-sm"},"Please select a user to see their messages")],-1)])))])])])}}};export{ys as default};
